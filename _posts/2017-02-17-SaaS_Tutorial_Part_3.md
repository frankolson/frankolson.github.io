---
layout:     post
title:      "SaaS Tutorial Part 3"
subtitle:   "Devise and Users"
date:       2017-02-17 12:00:00
author:     "Frank Olson"
header-img: "img/post-bg-03.jpg"
---

## Intro
In the third post of this series we are going to implement the Users model utilizing the Devise authentication gem as well as the accompanying spec tests.

A User in our situation will want to create a personal account at the same time as signing up their store. Becuase of this, we are also going to be updating our Account model to include creating an initial User on Account creation.

Again, if you want to look at the source code for this post [look here!](https://github.com/frankolson/CoffeeTracking/tree/part_3)

---

## Outline
1. [Creating the Users with Devise](#section-1)
2. [User Model Specs](#section-2)
3. [Add Users to Account Creation](#section-3)
4. [Creating  User Sign-in Specs](#section-4)
5. [Implementing Sign-in Views](#section-5)

---

## The Good Stuff

### Creating the Users with Devise {#section-1}

Taking a look at the [Devise Documentation](https://github.com/plataformatec/devise), the first few things we have to do are: add the gem to our Gemfile, generate the necessary files, and add the default mailer to our configuration files.

~~~ruby
# Gemfile

gem 'devise'
~~~

~~~
bundle install
rails g devise:install
~~~

~~~ruby
# config/environments/development.rb

Rails.application.configure do
  # Settings specified here will take precedence over those in config/application.rb.
  config.action_mailer.default_url_options = { host: 'localhost', port: 3000 }

  ...
end
~~~

~~~ruby
# config/environments/test.rb

Rails.application.configure do
  # Settings specified here will take precedence over those in config/application.rb.
  config.action_mailer.default_url_options = { host: 'localhost', port: 3000 }

  ...
end
~~~

We are also going to generate the Devise views so we can add Bootstrap theming later.

~~~
rails g devise:views
~~~

Now let's use the Devise generator to create our users.

~~~
rails g devise User
~~~

Before we migrate our database using the migration file just generated by Devise, we need to add a few attributes to the user model as well as enabling the Devise confirmable module.

~~~ruby
# db/migrate/20170217183143_devise_create_users.rb

class DeviseCreateUsers < ActiveRecord::Migration[5.0]
  def change
    create_table :users do |t|
      ## Custom Attributes
      t.string :first_name
      t.string :last_name

      ## Database authenticatable
      t.string :email,              null: false, default: ""
      t.string :encrypted_password, null: false, default: ""

      ## Recoverable
      t.string   :reset_password_token
      t.datetime :reset_password_sent_at

      ## Rememberable
      t.datetime :remember_created_at

      ## Trackable
      t.integer  :sign_in_count, default: 0, null: false
      t.datetime :current_sign_in_at
      t.datetime :last_sign_in_at
      t.inet     :current_sign_in_ip
      t.inet     :last_sign_in_ip

      ## Confirmable
      t.string   :confirmation_token
      t.datetime :confirmed_at
      t.datetime :confirmation_sent_at
      t.string   :unconfirmed_email # Only if using reconfirmable

      ## Lockable
      # t.integer  :failed_attempts, default: 0, null: false # Only if lock strategy is :failed_attempts
      # t.string   :unlock_token # Only if unlock strategy is :email or :both
      # t.datetime :locked_at


      t.timestamps null: false
    end

    add_index :users, :email,                unique: true
    add_index :users, :reset_password_token, unique: true
    # add_index :users, :confirmation_token,   unique: true
    # add_index :users, :unlock_token,         unique: true
  end
end
~~~

~~~ruby
# app/models/user.rb

class User < ApplicationRecord
  # Include default devise modules. Others available are:
  # :confirmable, :lockable, :timeoutable and :omniauthable
  devise :database_authenticatable, :registerable, :confirmable,
         :recoverable, :rememberable, :trackable, :validatable
end
~~~

Let's migrate the database and start up guard.

~~~
rails db:migrate db:test:prepare
bundle exec guard
~~~

Finally, time to commit our changes.

~~~
git add .
git commit -m "add the devse users"
~~~

### User Model Specs {#section-2}

Just like with the Accounts model, we need to add a model spec describing the validations and associations of the User model. We know we need the user to have:

1. a first name.
2. a last name.
3. a unique email.
4. and a password.

So edit the User model spec to include the following.

~~~ruby
# spec/models/user_spec.rb

require 'rails_helper'

RSpec.describe User, type: :model do
  describe 'validations' do
    it { should validate_presence_of(:first_name) }
    it { should validate_presence_of(:last_name) }
    it { should validate_presence_of(:email) }
    it { should validate_presence_of(:password) }
  end

  describe 'associations' do
  end
end
~~~

It should be noted that Devise already tests and checks for the uniqueness of a user's email, so we do not have to. Now that some of those tests are failing, we need to update the User model to get the spec tests to pass.

~~~ruby
# app/models/user.rb

class User < ApplicationRecord
  # Include default devise modules. Others available are:
  # :confirmable, :lockable, :timeoutable and :omniauthable
  devise :database_authenticatable, :registerable, :confirmable,
         :recoverable, :rememberable, :trackable, :validatable

  validates :first_name, presence: true
  validates :last_name, presence: true
end
~~~

Time to commit our progress.

~~~
git add .
git commit -m "add user spec tests and validations"
~~~

### Add Users to Account Creation {section-3}

Remember how in the previous post we gave the Accounts model a pending association test to check for user ownership? Well now we are going to finish that test and add user creation into Account creation. First let's update our Account specs and plan out how this relationship is going to work.

~~~ruby
# spec/models/account_spec.rb

require 'rails_helper'

RSpec.describe Account, type: :model do
  describe 'validations' do
    it { should validate_presence_of(:subdomain) }
    it { should validate_uniqueness_of(:subdomain).case_insensitive }

    it { should allow_value('franko').for(:subdomain) }
    it { should allow_value('test').for(:subdomain) }

    it { should_not allow_value('www').for(:subdomain) }
    it { should_not allow_value('WWW').for(:subdomain) }
    it { should_not allow_value('.test').for(:subdomain) }
    it { should_not allow_value('test/').for(:subdomain) }

    it 'should validate case insensitive uniqueness' do
      create(:account, subdomain: 'Test')
      expect(build(:account, subdomain: 'test')).to_not be_valid
    end
  end

  describe 'associations' do
    it { should belong_to :owner }
  end
end
~~~

~~~ruby
# spec/factories/users.rb

FactoryGirl.define do
  factory :user do
    first_name       "Test"
    last_name        "Name"
    sequence(:email) { |n| "email#{n}@gmail.com"}
    password         "testpassword"

    trait :confirmed do
      confirmed_at Time.now
    end
  end
end
~~~

~~~ruby
# spec/controllers/account_controller_spec.rb

require 'rails_helper'

describe AccountsController, type: :controller do
  describe 'GET #new' do
    it 'assigns a new Account to @account' do
      get :new
      expect(assigns(:account)).to be_a_new(Account)
    end
    it 'build and owner' do
      get :new
      expect(Account).to receive(:build_owner)
    end
    it 'renders the :new template' do
      get :new
      expect(response).to render_template(:new)
    end
  end

  describe 'POST #create' do
    context "with valid attributes" do
      it "saves the new account in the database" do
        expect{
          post :create, params: {
            account: attributes_for(:account),
            owner_attributes: attributes_for(:user)
          }
        }.to change(Account,:count).by(1)
      end

      it "redirects to the root page" do
        post :create, params: {
          account: attributes_for(:account),
          owner_attributes: attributes_for(:user)
        }
        expect(response).to redirect_to(root_path)
      end
    end

    context "with invalid attributes" do
      it "does not save the new account" do
        expect{
          post :create, params: { account: { subdomain: '' } }
        }.to_not change(Account,:count)
      end

      it "re-renders the new method" do
        post :create, params: { account: { subdomain: '' } }
        expect(response).to render_template(:new)
      end
    end
  end
end
~~~

Now that we have a breaking model spec test, let's go fix the model.

~~~ruby
# app/models/account.rb

class Account < ApplicationRecord
  RESTRICTED_SUBDOMAINS = %w(www)

  # Validations
  validates :subdomain, presence: true,
                        uniqueness: { case_sensitive: false },
                        format: { with: /\A[\w\-]+\Z/i, message: 'contains invalid characters' },
                        exclusion: { in: RESTRICTED_SUBDOMAINS,  message: 'restricted' }
  before_validation :downcase_subdomain

  # Associations
  belongs_to :owner, class_name: "User"
  accepts_nested_attributes_for :owner

  private

  def downcase_subdomain
    self.subdomain = subdomain.try(:downcase)
  end
end
~~~

Guard is saying owner must exist so let's update up our factory.

~~~ruby
# spec/factories/accounts.rb

FactoryGirl.define do
  factory :account do
    sequence(:subdomain) { |n| "subdomain#{n}"}
    association :owner, factory: :user
  end
end
~~~

Finally we need to fix our `AccountsController` class to accept its owner attributes on create.

~~~ruby
# app/controllers/accounts_controller.rb

require 'rails_helper'

describe AccountsController, type: :controller do
  describe 'GET #new' do
    it 'assigns a new Account to @account' do
      get :new
      expect(assigns(:account)).to be_a_new(Account)
    end
    it 'build and owner' do
      get :new
      expect(assigns(:account).build_owner).to be_a_new(User)
    end
    it 'renders the :new template' do
      get :new
      expect(response).to render_template(:new)
    end
  end

  describe 'POST #create' do
    context "with valid attributes" do
      it "saves the new account in the database" do
        expect{
          post :create, params: {
            account: attributes_for(:account)
                       .merge(owner_attributes: attributes_for(:user))
          }
        }.to change(Account,:count).by(1)
      end

      it "redirects to the root page" do
        post :create, params: {
          account: attributes_for(:account)
                     .merge(owner_attributes: attributes_for(:user))
        }
        expect(response).to redirect_to(root_path)
      end
    end

    context "with invalid attributes" do
      it "does not save the new account" do
        expect{
          post :create, params: { account: { subdomain: nil } }
        }.to_not change(Account,:count)
      end

      it "re-renders the new method" do
        post :create, params: { account: { subdomain: nil } }
        expect(response).to render_template(:new)
      end
    end
  end
end
~~~

Alright, so that is a ton of changes. We should commit our work now.

~~~
git add .
git commit -m "update account create to also create an owner"
~~~

### Creating  User Sign-in Specs {section-4}

Since Devise handles most of the testing for users, all we are going to do is create some feature specs designed to test user sign-up/sign-in behavior. Since later in the series we will being implementing the Devise invitable module, which should be the only way a user can join an account, we will not be testing individual user sign-up. Rather we will be testing user sign-up with account creation.

First we have to add a separate subdomain sequence to our factory so we can generate unique subdomains in any of our tests.

~~~ruby
# spec/factories/accounts.rb

FactoryGirl.define do
  sequence(:subdomain) { |n| "subdomain#{n}"} # <~ We just did this!

  factory :account do
    sequence(:subdomain) { |n| "subdomain#{n}"}
    association :owner, factory: :user
  end
end
~~~

Then we are going to be DRY programmers and modularize some of the code we are going to be reusing and put it in a RSpec support file.

~~~ruby
# spec/support/macros.rb

def sign_user_in(user, opts={})
  visit new_user_session_path
  fill_in 'Email', with: user.email
  fill_in 'Password', with: (opts[:password] || user.password)
  click_button 'Sign in'
end

def sign_up(subdomain)
  visit root_path
  click_link 'Create an account'

  fill_in 'First name', with: 'Frank'
  fill_in 'Last name', with: 'Olson'
  fill_in 'Email', with: 'frank@example.com'
  fill_in 'Password', with: 'ye$hallNotHAndshake'
  fill_in 'Password confirmation', with: 'ye$hallNotHAndshake'
  fill_in 'Subdomain', with: subdomain
  click_button 'Create Account'
end
~~~

Next we are going to create our two feature spec files.

~~~ruby
# spec/features/account_creation_feature_spec.rb

require 'rails_helper'

describe 'account creation' do
  let(:subdomain) { FactoryGirl.generate(:subdomain) }
  before do
    sign_up(subdomain)
  end

  it 'allows user to create account' do
    expect(Account.all.count).to eq(1)
  end

  it 'creates a user with an account' do
    expect(User.all.count).to eq(1)
  end
end
~~~

~~~ruby
# spec/features/authentication_feature_spec.rb

require 'rails_helper'

describe 'user authentication' do
  let(:user) {build(:user, :confirmed)}
  let(:account) {create(:account, owner: user)}

  it 'allows signin with valid credentials' do
    sign_user_in(account.owner)
    expect(page).to have_content('Signed in successfully')
  end

  it 'does not allow signin with invalid credentials' do
    sign_user_in(account.owner, password: 'wrong_password')
    expect(page).to have_content('Invalid Email or password')
  end

  it 'allows user to sign out' do
    sign_user_in(account.owner)

    click_link 'Sign out'
    expect(page).to have_content('Signed out successfully')
  end
end
~~~

Congratulations, now we have our failing spec tests. Let's commit our work and build up the views to pass our tests.

~~~
git add .
git commit -m "build the account creation and authentication feature specs"
~~~

### Implementing Sign-in Views and New Account Creation Views {#section-5}

First we are going to implement the `letter_opener` gem so we can easily test our mailers while in the development environment.

~~~ruby
# Gemfile

group :development do
  gem 'letter_opener'
end
~~~

~~~
bundle install
~~~

~~~ruby
# config/environments/development.rb

Rails.application.configure do
  config.action_mailer.delivery_method = :letter_opener
end
~~~

We now need to change up the layout view so we can have a header with a sign-in/sign-out button.

~~~erb
<!-- # app/views/layouts/application.html.erb -->

<!DOCTYPE html>
<html>
  <head>
    <title>CoffeeTracking</title>
    <%= csrf_meta_tags %>

    <%= stylesheet_link_tag    'application' %>
    <%= javascript_include_tag 'application' %>
  </head>

  <body>

    <header class="container">
      <nav class="navbar fixed-top navbar-light bg-faded">
        <div class="container">
          <%= link_to 'Coffee Tracker', root_path, class: 'navbar-brand' %>
          <% if user_signed_in? %>
            <div class="float-sm-right right-buttons">
              <%= link_to "Sign out", destroy_user_session_path, method: :delete, class: "btn btn-default navbar-btn" %>
            </div>
          <% else %>
            <div class="float-sm-right right-buttons">
              <%= link_to "Sign in", new_user_session_path, class: "btn btn-default navbar-btn" %>
            </div>
          <% end %>
        </div>
      </nav>
    </header>

    <div class="container">
      <%= flash_messages %>

      <div class="row">
        <%= yield %>
      </div>
    </div>

  </body>
</html>
~~~

Then let's fix the account creation page.

~~~erb
<!-- # app/views/accounts/new.html.erb -->

<div class="col-md-10 col-lg-6 offset-md-1 offset-lg-3 card card-block">
  <h2>Sign up for Coffee Tracker</h2>
  <%= simple_form_for @account do |f| %>
      <%= f.simple_fields_for :owner do |owner| %>
        <div class="row">
          <div class="col-sm-6">
            <%= owner.input :first_name %>
          </div>
          <div class="col-sm-6">
            <%= owner.input :last_name %>
          </div>
        </div>
        <%= owner.input :email %>
        <%= owner.input :password %>
        <%= owner.input :password_confirmation %>
      <% end %>
      <%= f.input :subdomain do %>
        <div class="input-group">
          <%= f.input_field :subdomain, placeholder: 'dublin', class: "form-control" %>
          <span class="input-group-addon">.coffeetracker.io</span>
        </div>
      <% end %>
    <%= f.button :submit, class:"btn-primary" %>
  <% end %>
</div>
~~~

![new header]({{ site.baseurl }}/img/saas_tutorial/new_header.png)

Finally, we need to add the bootstrap theming to all of the Devise views.

~~~erb
<!-- # app/views/devise/confirmations/new.html.erb -->

<div class="col-md-10 col-lg-6 offset-md-1 offset-lg-3 card card-block">
  <h2>Resend confirmation instructions</h2>
  <%= simple_form_for resource, :as => resource_name,
                                :url => confirmation_path(resource_name),
                                :html => {:method => :post} do |f| %>
    <%= f.input :email %>
    <%= f.button :submit, "Resend confirmation instructions", class: 'btn-primary' %>
  <% end %>
  <br>
  <%= render "devise/shared/links" %>
</div>
~~~

![confirmations new]({{ site.baseurl }}/img/saas_tutorial/confirmations_new.png)

~~~erb
<!-- # app/views/devise/passwords/edit.html.erb -->

<div class="col-md-6 offset-md-3 col-lg-4 offset-lg-4 card card-block">
  <h2>Change your password</h2>
  <%= simple_form_for(resource, as: resource_name,
                                url: password_path(resource_name),
                                html: { method: :put }) do |f| %>
    <%= f.input :reset_password_token, as: :hidden %>
    <%= f.full_error :reset_password_token %>

    <%= f.input :password, label: "New password", required: true, autofocus: true, hint: ("#{@minimum_password_length} characters minimum" if @minimum_password_length) %>
    <%= f.input :password_confirmation, label: "Confirm your new password", required: true %>

    <%= f.button :submit, "Change my password", class: 'btn-primary' %>

  <% end %>
  <%= render "devise/shared/links" %>
</div>
~~~

![password edit]({{ site.baseurl }}/img/saas_tutorial/passwords_edit.png)

~~~erb
<!-- # app/views/devise/passwords/new.html.erb -->

<div class="col-md-6 offset-md-3 col-lg-4 offset-lg-4 card card-block">
  <h2>Forgot your password?</h2>
  <%= simple_form_for(resource, as: resource_name,
                                url: password_path(resource_name),
                                html: { method: :post }) do |f| %>
    <%= f.input :email, required: true, autofocus: true %>

    <%= f.button :submit, "Send me reset password instructions", class: 'btn-primary' %>
  <% end %>

  <%= render "devise/shared/links" %>
</div>
~~~

![password new]({{ site.baseurl }}/img/saas_tutorial/passwords_new.png)

~~~erb
<!-- # app/views/devise/sessions/new.html.erb -->

<div class="col-md-6 offset-md-3 col-lg-4 offset-lg-4 card card-block">
  <h2>Sign in</h2>
  <%= simple_form_for(resource, as: resource_name,
                                url: session_path(resource_name),
                                wrapper_mappings: { boolean: :vertical_boolean }) do |f| %>
      <%= f.input :email, label: false do %>
        <div class="input-group">
          <%= f.input_field :email, class: "form-control", placeholder: "Email" %>
          <span class="input-group-addon"><i class="fa fa-user"></i></span>
        </div>
      <% end %>
      <%= f.input :password, label: false do %>
        <div class="input-group">
          <%= f.password_field :password, class: "form-control", placeholder: "Password" %>
          <span class="input-group-addon"><i class="fa fa-lock"></i></span>
        </div>
      <% end %>
      <%= f.input :remember_me, :as => :boolean, :label => false, :inline_label => true if devise_mapping.rememberable? %>
      <%= f.button :submit, "Sign in", class: "btn-primary btn-block btn-lg" %>
  <% end %>
  <br>
  <%= render "devise/shared/links" %>
</div>
~~~

![sessions new]({{ site.baseurl }}/img/saas_tutorial/sessions_new.png)


I also like to remove the `</br>` tags that are added by default in the `devise/shared/links` partial.

~~~erb
<!-- # app/views/devise/shared/_links.html.erb -->

<%- if controller_name != 'sessions' %>
  <%= link_to "Log in", new_session_path(resource_name) %>
<% end -%>

<%- if devise_mapping.registerable? && controller_name != 'registrations' %>
  <%= link_to "Sign up", new_registration_path(resource_name) %>
<% end -%>

<%- if devise_mapping.recoverable? && controller_name != 'passwords' && controller_name != 'registrations' %>
  <%= link_to "Forgot your password?", new_password_path(resource_name) %>
<% end -%>

<%- if devise_mapping.confirmable? && controller_name != 'confirmations' %>
  <%= link_to "Didn't receive confirmation instructions?", new_confirmation_path(resource_name) %>
<% end -%>

<%- if devise_mapping.lockable? && resource_class.unlock_strategy_enabled?(:email) && controller_name != 'unlocks' %>
  <%= link_to "Didn't receive unlock instructions?", new_unlock_path(resource_name) %>
<% end -%>

<%- if devise_mapping.omniauthable? %>
  <%- resource_class.omniauth_providers.each do |provider| %>
    <%= link_to "Sign in with #{OmniAuth::Utils.camelize(provider)}", omniauth_authorize_path(resource_name, provider) %>
  <% end -%>
<% end -%>
~~~

As always, let's finish this off with a commit.

~~~
git add .
git commit -m "update the authentication views"
~~~
